# BlockEraTwoFA Plugin

BlockEraTwoFA — плагин для Paper 1.21.x, добавляющий многофакторную (TOTP и Telegram) аутентификацию на сервере Minecraft. Репозиторий содержит исходный код, конфигурацию и ресурсы, необходимые как для запуска на сервере, так и для доработки.

## Возможности
- Обязательная 2FA на основе прав: определите, какие игроки должны пройти проверку, прежде чем начать игру.
- Поддержка TOTP и Telegram-подтверждений (режимы `totp`, `telegram`, `totp_telegram`).
- Заморозка действий игрока до прохождения проверки: блокировка чата, команд, движение и урон настраиваются в конфиге.
- Гибкая локализация сообщений (`messages.yml`) и кастомные алиасы команд `/2fa`.
- Хранение секретов в MySQL с поддержкой AES-шифрования ключом из переменной окружения.
- «Доверенные устройства» — автоматическое запоминание IP/локали/платформы Bedrock или Java на 30 дней с управлением через конфиг.
- Настраиваемый эффект зелья (по умолчанию — слепота) во время ожидания подтверждения.

## Требования
- **Java**: JDK/JRE 21.
- **Сервер**: Paper 1.21.5 (подойдёт любая сборка Paper 1.21.x с совместимым API).
- **База данных**: MySQL 8.x или совместимая (MariaDB 10.5+). Плагин создаёт необходимые таблицы автоматически.
- **Дополнительные плагины**: не требуются. Плагин работает автономно.

## Быстрый старт на сервере
1. Скачайте собранный JAR (`blockera-twofa-0.1.1.jar`) или соберите его самостоятельно (см. раздел «Сборка»).
2. Поместите JAR в папку `plugins/` вашего Paper-сервера.
3. Запустите сервер один раз — плагин создаст `config.yml` и `messages.yml` в `plugins/BlockEraTwoFA/`.
4. Настройте подключение к базе данных и режимы безопасности (см. раздел «Конфигурация»).
5. (Опционально) Установите переменную окружения с ключом шифрования `TWOFA_MASTER_KEY` (Base64-строка длиной 32 байта для AES-256).
6. Выполните `/2fa reload` в игре или в консоли, чтобы применить изменения без перезапуска.

## Конфигурация
Основные параметры находятся в `config.yml`:

### `storage`
Настройки подключения к MySQL: хост, порт, имя БД, логин, пароль и размер пула (`pool.maximumPoolSize`).

### `security`
- `mode`: какой способ подтверждения использовать (`totp`, `telegram`, `totp_telegram`).
- `secret_encryption_key_env`: имя переменной окружения с Base64-ключом для шифрования секретов TOTP.
- `secret_encryption_key_b64`: можно прописать ключ напрямую, если переменные окружения недоступны.
- `totp`: параметры генерации кодов (issuer, длина, период, окно допустимого отклонения).
- `trusted_devices`: включает или выключает доверенные устройства и определяет, сколько дней хранится токен (по умолчанию 30).
- `policy.required_permission`: право, наличие которого делает 2FA обязательной.

### `session`
`expire_minutes` — сколько минут хранится успешная авторизация.

### `ui`
Префикс сообщений, список команд, разрешённых во время ожидания подтверждения, шаблон QR-ссылки и параметры «заморозки»/разморозки игрока (walk/fly speed, invulnerable, collidable) и настраиваемый эффект зелья (по умолчанию `BLINDNESS`).

Секция `ui.freeze.effect` позволяет выбрать тип зелья, усиление, длительность в тиках и отображение частиц/иконки. Чтобы отключить эффект полностью, укажите `type: NONE`.

### `commands`
Алиасы для подпунктов `/2fa`: `setup`, `confirm`, `status`, `disable`, `force_disable`, `reload`, а также команды Telegram (`telegram_link`, `telegram_status`, `telegram_unlink`).
### `telegram`
Параметры интеграции: имя бота, ссылка на помощь, время жизни челенджа, частота опроса БД, поведение при входе (`auth_on_join`, `kick_after_seconds`, `cooldown_minutes`) и отдельные настройки «заморозки».

### Локализация (`messages.yml`)
Все сообщения, отображаемые игроку, можно перевести или изменить. Используйте плейсхолдеры из файла по умолчанию. После правок выполните `/2fa reload`.

## Команды и права
- `/2fa setup` — начать настройку 2FA.
- `/2fa confirm <код>` — подтвердить код из приложения/Telegram.
- `/2fa status` — показать статус 2FA.
- `/2fa disable` — отключить 2FA (при наличии доступа и действующего кода).
- `/2fa force-disable <ник>` — отключить 2FA игроку от имени администратора (требует `blockera.twofa.admin`).
- `/2fa reload` — перезагрузить конфигурацию и сообщения (требует `blockera.twofa.admin`).
- Telegram-команды управляются через алиасы `telegram_link`, `telegram_status`, `telegram_unlink`.

Права доступа:
- `blockera.twofa.use` — доступ к базовым командам (по умолчанию true).
- `blockera.twofa.admin` — административные действия (`/2fa reload`, `/2fa force-disable`).
- `blockera.twofa.bypass` — пропуск 2FA.
- `blockera.twofa.required` — наличие права делает 2FA обязательной.

## Сборка
1. Установите JDK 21 (Gradle wrapper уже включён в репозиторий).
2. Клонируйте репозиторий и перейдите в директорию проекта.
3. Запустите `./gradlew build` или `./gradlew shadowJar` — wrapper автоматически скачает совместимую версию Gradle и соберёт JAR.
4. Готовый JAR появится в `build/libs/blockera-twofa-0.1.1.jar` и уже содержит зависимости.

Для локального тестирования можно развернуть Paper-сервер на машине разработчика и скопировать JAR в папку `plugins`.

## Структура проекта и доработка
- `src/main/java/space/blockera/twofa/BlockEraTwoFAPlugin.java` — точка входа плагина, загрузка конфигурации, регистрация команд и слушателей.
- `commands/TwoFACommand.java` — логика всех подпунктов `/2fa`, работа с конфигом и сообщениями.
- `listeners/` — обработчики событий безопасности, блокировки движения, телеграм-логики.
- `storage/` — репозитории и фабрики подключения к базе данных.
- `totp/`, `session/`, `security/` — доменные сервисы и утилиты.
- `resources/` — `plugin.yml`, `config.yml`, `messages.yml`.

Рекомендации по разработке:
1. Для новых настроек добавляйте значения в `config.yml` и считывайте их в соответствующих классах. Не забудьте поддержать горячую перезагрузку через `reloadCore()`.
2. Сообщения для игроков добавляйте в `messages.yml` и в класс `Messages`, чтобы поддерживалась локализация.
3. Перед коммитом запускайте `gradle build` для проверки компиляции.
4. Поддерживайте стиль кода Java 17+/21, избегайте обёрток try/catch вокруг импортов и следуйте существующим паттернам DI через `rewire()`.

## Обновление плагина
При смене версии:
1. Скопируйте новый JAR в `plugins/`, заменив старый.
2. Проверьте изменения в `config.yml`/`messages.yml`. Плагин автоматически добавит отсутствующие ключи и сохранит ваши значения.
3. Выполните `/2fa reload` или перезапустите сервер.

## Поддержка
Если вы обнаружили ошибку:
1. Включите режим отладки (`debug: true`) при необходимости (если будет добавлен в конфиг).
2. Проверьте логи сервера (`logs/latest.log`).
3. Создайте issue в репозитории с описанием шагов для воспроизведения и логами.

Приятной и безопасной игры!

### FAQ
**Как отключить 2FA, если игрок потерял код?**

Попросите администратора выполнить `/2fa force-disable <ник>`. Команда удалит секрет и сбросит статус 2FA для указанного игрока, после чего он сможет заново пройти настройку через `/2fa setup`.
